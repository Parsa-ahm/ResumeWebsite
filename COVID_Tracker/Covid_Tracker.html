<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>COVID‑19 Dashboard - Parsa Ahmadizadeh</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <link rel="stylesheet" href="../styles/styles.css" />
    <link rel="stylesheet" href="../styles/covid-page.css" />
</head>

<body>
    <script src="../components/navbar-loader.js"></script>

    <!-- Header Section -->
    <section id="header">
        <div class="container">
            <div class="row">
                <div class="col-lg-9">
                    <div class="covid-label">
                        <span class="covid-label-dot"></span>
                        Data Visualization
                    </div>
                    <h1 class="covid-title">COVID‑19 Dashboard</h1>
                    <p class="covid-desc">
                        A dashboard that tracks COVID-19 data from the disease.sh API. Stay up to date with the virus
                        and explore what's happening around the world. (The API stopped updating in September 2023.)
                    </p>
                </div>
            </div>
        </div>
    </section>

    <div class="container py-5">
        <!-- Global Summary -->
        <section class="mb-5">
            <div class="text-center mb-4">
                <div class="covid-section-label">Overview</div>
                <h2 class="covid-section-title mb-0">Global Summary</h2>
            </div>
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="standard-card">
                        <div class="card-body p-0">
                            <div id="summary"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="section-divider"></div>

        <!-- Global Trend Chart -->
        <section class="mb-5">
            <div class="text-center mb-4">
                <div class="covid-section-label">Trends</div>
                <h2 class="covid-section-title mb-0">Daily New Cases vs. Deaths</h2>
            </div>
            <div class="standard-card covid-chart-card">
                <canvas id="covidChart" height="200"></canvas>
            </div>
        </section>

        <div class="section-divider"></div>

        <!-- Per-country GeoChart -->
        <section class="mb-5">
            <div class="text-center mb-4">
                <div class="covid-section-label">Geography</div>
                <h2 class="covid-section-title mb-0">Total Cases by Country</h2>
            </div>
            <div class="standard-card covid-chart-card">
                <div id="regions_div" style="min-height: 400px;"></div>
            </div>
        </section>

        <div class="section-divider"></div>

        <!-- Top 10 Countries -->
        <section>
            <div class="text-center mb-4">
                <div class="covid-section-label">Rankings</div>
                <h2 class="covid-section-title mb-0">Top 10 Countries by Total Cases</h2>
            </div>
            <div class="standard-card covid-chart-card">
                <canvas id="barChart" height="200"></canvas>
            </div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        google.charts.load('current', { packages: ['geochart'] });

        let covidLineChart, topBarChart, geoChart;

        function getAccentRgba(alpha) {
            const rgb = getComputedStyle(document.body).getPropertyValue('--accent-rgb').trim() || '236, 66, 66';
            return `rgba(${rgb}, ${alpha})`;
        }

        document.addEventListener('DOMContentLoaded', loadData);

        async function loadData() {
            document.getElementById('summary').innerHTML = `<p class="text-center py-4 text-muted">Loading data…</p>`;
            if (covidLineChart) covidLineChart.destroy();
            if (topBarChart) topBarChart.destroy();

            try {
                const histRes = await fetch('https://disease.sh/v3/covid-19/historical/all');
                const hist = await histRes.json();
                const dates = Object.keys(hist.cases);
                const dailyCases = [], dailyDeaths = [];
                let prevC, prevD;
                dates.forEach((date, i) => {
                    const c = hist.cases[date], d = hist.deaths[date];
                    if (i === 0) {
                        dailyCases.push(0);
                        dailyDeaths.push(0);
                    } else {
                        dailyCases.push(c - prevC);
                        dailyDeaths.push(d - prevD);
                    }
                    prevC = c;
                    prevD = d;
                });
                const totalCases = dailyCases.slice(1).reduce((a, b) => a + b, 0);
                const totalDeaths = dailyDeaths.slice(1).reduce((a, b) => a + b, 0);
                const avgCases = (totalCases / (dates.length - 1)).toFixed(2);
                const avgDeaths = (totalDeaths / (dates.length - 1)).toFixed(2);

                document.getElementById('summary').innerHTML = `
                    <table class="table table-bordered mb-0 covid-summary-table">
                        <thead>
                            <tr><th>Metric</th><th>Value</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Total New Cases</td><td>${totalCases.toLocaleString()}</td></tr>
                            <tr><td>Total New Deaths</td><td>${totalDeaths.toLocaleString()}</td></tr>
                            <tr><td>Avg Daily Cases</td><td>${avgCases}</td></tr>
                            <tr><td>Avg Daily Deaths</td><td>${avgDeaths}</td></tr>
                        </tbody>
                    </table>`;

                const accent = getAccentRgba;
                const ctxLine = document.getElementById('covidChart').getContext('2d');
                covidLineChart = new Chart(ctxLine, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Daily New Cases',
                                data: dailyCases,
                                borderColor: accent(1),
                                backgroundColor: accent(0.25),
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Daily New Deaths',
                                data: dailyDeaths,
                                borderColor: 'rgba(255, 99, 132, 0.9)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { ticks: { color: 'rgba(226,226,236,0.6)' } },
                            y: { beginAtZero: true, ticks: { color: 'rgba(226,226,236,0.6)' } }
                        },
                        plugins: {
                            title: { display: false },
                            tooltip: { mode: 'index', intersect: false },
                            legend: {
                                position: 'bottom',
                                labels: { color: 'rgba(226,226,236,0.8)' }
                            }
                        },
                        interaction: { mode: 'index', intersect: false }
                    }
                });

                const countryRes = await fetch('https://disease.sh/v3/covid-19/countries');
                const countries = await countryRes.json();
                const geoData = [['Country', 'Total Cases']];
                countries.forEach(c => {
                    const loc = c.countryInfo.iso2 || c.country;
                    geoData.push([loc, c.cases]);
                });
                drawGeoChart(geoData);

                const top10 = countries.sort((a, b) => b.cases - a.cases).slice(0, 10);
                drawBarChart(top10.map(c => c.country), top10.map(c => c.cases));

            } catch (err) {
                document.getElementById('summary').innerHTML = `
                    <div class="alert alert-danger m-0 mx-3 my-3">
                        Error loading data: ${err.message}
                    </div>`;
                console.error(err);
            }
        }

        function drawGeoChart(dataArray) {
            const dataTable = google.visualization.arrayToDataTable(dataArray);
            const options = {
                colorAxis: { colors: ['#1a1a2e', '#e63946', '#ff6b6b'] },
                backgroundColor: { fill: 'transparent' },
                datalessRegionColor: 'rgba(255,255,255,0.05)',
                defaultColor: '#f5f5f5'
            };
            geoChart = new google.visualization.GeoChart(document.getElementById('regions_div'));
            geoChart.draw(dataTable, options);
        }

        function drawBarChart(labels, data) {
            const accent = getAccentRgba;
            const ctxBar = document.getElementById('barChart').getContext('2d');
            topBarChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Total Cases',
                        data,
                        backgroundColor: accent(0.7),
                        borderColor: accent(0.9),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: 'rgba(226,226,236,0.6)' }
                        },
                        x: { ticks: { color: 'rgba(226,226,236,0.6)' } }
                    },
                    plugins: {
                        title: { display: false },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.parsed.y.toLocaleString()} cases`
                            }
                        }
                    }
                }
            });
        }

        window.addEventListener('resize', () => {
            if (geoChart) geoChart.draw();
        });
    </script>
</body>

</html>
